<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>NLP Test Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .card { border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-radius: 12px; }
        .status-pass { color: #198754; font-weight: bold; background: #d1e7dd; padding: 4px 8px; border-radius: 6px; }
        .status-fail { color: #dc3545; font-weight: bold; background: #f8d7da; padding: 4px 8px; border-radius: 6px; }
    </style>
</head>
<body>

<nav class="navbar navbar-light bg-white shadow-sm mb-4">
    <div class="container">
        <a class="navbar-brand fw-bold text-primary" href="#">
            <i class="fas fa-microscope me-2"></i>NLP Evaluation Dashboard
        </a>
        <a href="/" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left"></i> Quay v·ªÅ App</a>
    </div>
</nav>

<div class="container">
    <div class="card p-4 mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h5 class="fw-bold text-dark">üìÇ Nh·∫≠p b·ªô d·ªØ li·ªáu ki·ªÉm th·ª≠ (CSV)</h5>
                <p class="text-muted small mb-0">File CSV c·∫ßn c√≥ c·ªôt: <code>id, text, expected_time, expected_location, expected_title</code></p>
            </div>
            <div class="col-md-4">
                <div class="input-group">
                    <input type="file" class="form-control" id="csvFileInput" accept=".csv">
                    <button class="btn btn-primary" onclick="runNLPTest()">
                        <i class="fas fa-play me-2"></i>Ch·∫°y Test
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboardArea" class="d-none">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card h-100 p-3">
                    <h6 class="text-center fw-bold text-secondary mb-3">T·ª∂ L·ªÜ CH√çNH X√ÅC</h6>
                    <div style="height: 250px; position: relative;">
                        <canvas id="accuracyChart"></canvas>
                    </div>
                    <div class="text-center mt-3">
                        <h2 class="display-4 fw-bold text-primary" id="scoreText">0%</h2>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card h-100 p-4">
                    <h6 class="fw-bold text-secondary mb-4">TH·ªêNG K√ä CHI TI·∫æT</h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="p-3 bg-light rounded-3">
                                <div class="text-muted small">T·ªïng s·ªë c√¢u</div>
                                <h3 class="fw-bold text-dark mb-0" id="totalCount">0</h3>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 bg-success bg-opacity-10 rounded-3">
                                <div class="text-success small">Ch√≠nh x√°c (Pass)</div>
                                <h3 class="fw-bold text-success mb-0" id="passCount">0</h3>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 bg-danger bg-opacity-10 rounded-3">
                                <div class="text-danger small">Sai l·ªách (Fail)</div>
                                <h3 class="fw-bold text-danger mb-0" id="failCount">0</h3>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <span>K·∫øt qu·∫£ chi ti·∫øt b√™n d∆∞·ªõi:</span>
                        <button class="btn btn-success" onclick="exportResultCSV()">
                            <i class="fas fa-file-csv me-2"></i>T·∫£i B√°o C√°o K·∫øt Qu·∫£
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-white py-3">
                <h6 class="fw-bold m-0">üìã B·∫£ng chi ti·∫øt t·ª´ng c√¢u</h6>
            </div>
            <div class="table-responsive" style="max-height: 500px;">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th width="5%">ID</th>
                            <th width="30%">Input</th>
                            <th width="15%">Time (Mong ƒë·ª£i/Th·ª±c t·∫ø)</th>
                            <th width="15%">Location (Mong ƒë·ª£i/Th·ª±c t·∫ø)</th>
                            <th width="20%">Title (Mong ƒë·ª£i/Th·ª±c t·∫ø)</th>
                            <th width="10%">Tr·∫°ng th√°i</th>
                        </tr>
                    </thead>
                    <tbody id="resultTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let myChart = null;
    let currentData = []; // L∆∞u d·ªØ li·ªáu ƒë·ªÉ export

    function runNLPTest() {
        const fileInput = document.getElementById('csvFileInput');
        if (fileInput.files.length === 0) {
            alert("Vui l√≤ng ch·ªçn file CSV!");
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        const btn = document.querySelector('button[onclick="runNLPTest()"]');
        const oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
        btn.disabled = true;

        fetch('/api/test-nlp', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            btn.innerHTML = oldText;
            btn.disabled = false;

            if (data.success) {
                currentData = data.data; 
                showDashboard(data);
            } else {
                alert("L·ªói: " + data.error);
            }
        })
        .catch(err => {
            btn.innerHTML = oldText;
            btn.disabled = false;
            alert("L·ªói k·∫øt n·ªëi Server!");
        });
    }

    function showDashboard(data) {
        document.getElementById('dashboardArea').classList.remove('d-none');
        
        document.getElementById('scoreText').innerText = data.accuracy + '%';
        document.getElementById('totalCount').innerText = data.total;
        document.getElementById('passCount').innerText = data.correct;
        document.getElementById('failCount').innerText = data.fail;

        renderChart(data.correct, data.fail);
        renderResults(data);
    }

    function renderResults(data) {
        const tbody = document.getElementById('resultTableBody');
        tbody.innerHTML = ''; 
        
        data.data.forEach(row => {
            const statusBadge = row.status === 'PASS' 
                ? `<span class="status-pass"><i class="fas fa-check"></i> PASS</span>` 
                : `<span class="status-fail"><i class="fas fa-times"></i> FAIL</span>`;
            
            const trClass = row.status === 'FAIL' ? 'table-danger' : '';
            
            // --- S·ª¨A L·ªñI ·ªû ƒê√ÇY: X·ª≠ l√Ω null an to√†n ---
            const errorMsg = row.error || ""; 
            const isTimeErr = errorMsg.includes("Gi·ªù");
            const isLocErr = errorMsg.includes("V·ªã tr√≠");
            const isTitleErr = errorMsg.includes("Ti√™u ƒë·ªÅ");
            // ------------------------------------------

            const formatCell = (exp, act, isError) => {
                // N·∫øu sai th√¨ ch·ªØ th·ª±c t·∫ø m√†u ƒë·ªè, ƒë·∫≠m
                const color = isError ? 'text-danger fw-bold' : 'text-dark';
                return `<div class="small text-muted">${exp}</div><div class="${color}">${act}</div>`;
            };

            const tr = `
                <tr class="${trClass}">
                    <td>${row.id}</td>
                    <td><small>${row.text}</small></td>
                    <td>${formatCell(row.expected_time, row.actual_time, isTimeErr)}</td>
                    <td>${formatCell(row.expected_loc, row.actual_loc, isLocErr)}</td>
                    <td>${formatCell(row.expected_title, row.actual_title, isTitleErr)}</td>
                    <td>${statusBadge}</td>
                </tr>
            `;
            tbody.innerHTML += tr;
        });
    }

    function renderChart(pass, fail) {
        const ctx = document.getElementById('accuracyChart').getContext('2d');
        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Ch√≠nh x√°c', 'Sai s√≥t'],
                datasets: [{
                    data: [pass, fail],
                    backgroundColor: ['#198754', '#dc3545'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                cutout: '70%'
            }
        });
    }

    // H√†m xu·∫•t CSV t·ª´ tr√¨nh duy·ªát
    function exportResultCSV() {
        if (currentData.length === 0) return;

        let csvContent = "data:text/csv;charset=utf-8,";
        // Header c√≥ th√™m BOM ƒë·ªÉ Excel m·ªü kh√¥ng l·ªói font ti·∫øng Vi·ªát
        csvContent += "\uFEFF"; 
        csvContent += "ID,Input Text,Expected Time,Actual Time,Expected Loc,Actual Loc,Expected Title,Actual Title,Status,Error\n";

        currentData.forEach(row => {
            // Escape d·∫•u ph·∫©y trong n·ªôi dung b·∫±ng ngo·∫∑c k√©p
            const escape = (str) => `"${String(str || '').replace(/"/g, '""')}"`;
            
            const line = [
                row.id,
                escape(row.text),
                escape(row.expected_time), escape(row.actual_time),
                escape(row.expected_loc), escape(row.actual_loc),
                escape(row.expected_title), escape(row.actual_title),
                row.status,
                escape(row.error)
            ].join(",");
            
            csvContent += line + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "nlp_test_report.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>
</html>